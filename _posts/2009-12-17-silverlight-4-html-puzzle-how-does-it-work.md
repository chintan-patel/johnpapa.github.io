---
layout: post
title: Silverlight 4 HTML Puzzle&#58; How Does It Work?
date: 2009-12-17 04:12
author: John
comments: true
categories: [Silverlight, Uncategorized]
---
<p><a href="http://weblogs.asp.net/scottgu/archive/2009/12/16/silverlight-4-demos-from-my-pdc-keynote-now-available.aspx">Scott Guthrie just announced on his blog</a> that many of <a href="http://www.silverlight.net/community/samples/silverlight-4-beta/">the demos that he presented during the PDC keynote are now available online</a>. Both the demos and their source code are now online and available for you to download. Be sure to go grab the code and check them out! </p>  <blockquote>   <p><em>Learn More: </em>If you are interested in learning more about the features in Silverlight 4 beta, grab the <a href="http://ecn.channel9.msdn.com/o9/learn/Silverlight4/Labs/Overview/WhatsNewInSilverlight4.docx">Silverlight 4 Technical Whitepaper here</a>. You can also walk through some hands on labs and other learning materials from both:</p>    <ul>     <li><a href="http://channel9.msdn.com/learn/courses/Silverlight4/">Channel 9’s Silverlight 4 Training</a></li>      <li><a href="http://silverlight.net/learn/">Silverlight.net’s Silverlight 4 beta learning section</a>&#160;&#160; </li>   </ul> </blockquote>  <p>I decided to break down the project for the HTML Hosting &amp; Puzzle application for those who are interested in how it works.</p>  <p><img src="http://weblogs.asp.net/blogs/scottgu/image_734F75FE.png" width="519" height="291" /></p>  <p><u><strong>What does it do?</strong></u></p>  <p>This project demonstrates many features, including these features:</p>  <ul>   <li>Multi-Touch gestures</li>    <li>WebBrowser control</li>    <li>HTML Brush</li> </ul>  <blockquote>   <p>The HTML Hosting &amp; Puzzle application shows off using the new Silverlight 4 WebBrowser control in an out of browser application (note: you must run the application out of the browser for it to work).&#160; It allows you to use the control both interactively (meaning you can click the HTML within it and run it like an application).&#160; It also allows you to use the hosted HTML as a brush that you can apply to other Silverlight controls. For fun you can click the second tab and you’ll get <a href="http://en.wikipedia.org/wiki/Rickrolling">rick-rolled</a> to YouTube.&#160; You can still use the HTML as a brush and carve it up into a jigsaw – even though the video is still playing (using<a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_2.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; margin-left: 0px; border-top: 0px; margin-right: 0px; border-right: 0px" title="image" border="0" alt="image" align="right" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb.png" width="181" height="291" /></a> Flash hosted within the HTML). Also, if you have a multi-touch device, you can use your fingers to drag and rotate puzzle pieces.</p> </blockquote>  <p><u><strong>The Solution Explorer</strong></u></p>  <p>The project is named SLMTPuzzle (Silverlight Multi-Touch Puzzle) and contains a set of images, a generic.xaml for some custom controls, and a series of Views and code files for the puzzle logic. </p>  <p><u><strong>Vector.cs</strong></u></p>  <p>The Vector struct is used in presenting the motion for the puzzle pieces.</p>  <p><u><strong>TouchProcessor.cs</strong></u></p>  <p>This contains a helper class, TouchProcessor, and several other helper classes that capture and process touch events. This is not required for multi-touch, but make sit easier to process the events.</p>  <p><u><strong>PuzzleDesigner.xaml</strong></u></p>  <p>This control is actually not used in the project and can be excluded from it. I used this control simply as a design surface to create the puzzle pieces and make it obvious what shapes I needed. Notice that there are 9 shapes for the puzzle pieces. With these 9 shapes a puzzle of various larger sizes can be created. For example, in a puzzle that is 6 across the top and 3 tall (18 pieces in total), the top center piece would be used 4 times as would the middle and bottom center pieces.</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_6.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_2.png" width="244" height="202" /></a> </p>  <p>Drawing the puzzle pieces was quite simple using Expression Blend. I put the basic steps to create the “Top left” and “Top center” puzzle pieces here:</p>  <p>1. Make the container object a Canvas (Grid panels can resize and stretch, which we do not want in this case)</p>  <p>2. Create a rectangle of the width and height you desire. Set the fill color to yellow.</p>  <p>3. Add a circle using the ellipse tool. You can make it a circle by holding the SHIFT key down while sizing the ellipse. Set the fill color to green. (Note the size of the circle, we’ll be using this again later)</p>  <p>4. Copy and paste the circle shape to make a duplicate. Set this circle’s Fill color to red. (The colors are simply for demonstration purposes.)</p>  <p>5. Place the red circle on the right side of the rectangle and the green circle on the bottom of the rectangle. Make exactly about a 3rd of the circles overlap the rectangle. Your control should look something like this:</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_12.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_5.png" width="244" height="179" /></a>&#160;</p>  <p>6. Select the 3 shapes.</p>  <p>7. Right click the selection and choose from the menu Combine | Unite. The shapes are now combined into a single path as shown below. The circles became the nubs for the puzzle piece.</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_14.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_6.png" width="244" height="188" /></a> </p>  <p>8. This puzzle piece could now work as the top left piece. Now that it is created, let’s create the top middle piece, so copy the entire piece and paste it to create a duplicate. Set the Fill of the new piece to Blue.</p>  <p>9. Align the 2 pieces as shown below.</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_18.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_8.png" width="244" height="94" /></a> </p>  <p>10. Set the canvas’ background to white. This will make it easier to see if the puzzle pieces align properly.</p>  <p>11. Create another circle with the same exact size as the puzzle nub you created in step 3. Set its fill color to Red.</p>  <p>12. Position the red circle directly over the right nub of the yellow puzzle piece.</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_20.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_9.png" width="244" height="95" /></a> </p>  <p>13. Position the blue puzzle piece adjacent to the yellow puzzle piece.</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_22.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_10.png"
width="244" height="102" /></a> </p>  <p>14. Now it is time to carve a shape out the blue puzzle piece so the yellow puzzle piece can fit it. select the red circle and the blue puzzle piece.</p>  <p>15. Right click and from the menu choose Combine | Subtract. This subtracts the red circle from the blue path. The results should look as follows:</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_24.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_11.png" width="244" height="104" /></a> </p>  <p>16. Notice the puzzle pieces fit together and can be pulled apart as shown below.</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_26.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_12.png" width="244" height="94" /></a> </p>  <p>This process can be repeated to create various shapes of puzzle pieces. Of course, you can get much more creative in creating puzzle pieces, but this is a simple way to get started. The paths for these shapes can then be used as the basis for the puzzle pieces.</p>  <p><strong><u>HtmlPuzzlePiece.cs</u></strong></p>  <p>The puzzle pieces themselves are represented by the HtmlPuzzlePiece custom control. This custom control contains all of the logic necessary to handle the events and motion for each puzzle piece. Each puzzle will contain many instances of this control, using various paths to shape the puzzle pieces.</p>  <p><strong><u>HtmlPuzzle.cs</u></strong></p>  <p>The puzzle is represented by the custom control HtmlPuzzle, which handles various events and actions such as:</p>  <ul>   <li>Navigating to a web address to display the HTML content in the WebBrowser control</li>    <li>Redrawing the HTML content using the HtmlBrush in the puzzle pieces</li>    <li>Setting the redraw rate to 60x per second</li>    <li>Toggle the state between the WebBrowser control (interactive HTML) and the HtmlBrush mode (for video)</li>    <li>Scramble the puzzle pieces</li>    <li>Solve the entire puzzle</li>    <li>Solve one piece of the puzzle (hint)</li> </ul>  <p>As you can see, the HtmlPuzzle custom control is where the bulk of the interaction is handled. </p>  <p><strong><u>MainPage.xaml</u></strong></p>  <p>This is the main user control that loads the WebBrowser control or the puzzle (through the HtmlPuzzle control). It has a button which toggles the state for the HtmlPuzzle control between the WebBrowser control (the Browse button) and the puzzle ( the Puzzlify button). </p>  <p>“Browse” mode</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_32.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_15.png" width="244" height="152" /></a> </p>  <p>“Puzzle” mode</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_30.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_14.png" width="244" height="152" /></a> </p>  <p><strong><u>InstallView.xaml</u></strong></p>  <p>The InstallView control is shown when the application is run inside of the browser. If the application is not installed out-of-browser the InstallView control will allow the user to install the application by clicking a button, as shown below:</p>  <p><a href="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_34.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="http://images.johnpapa.net/wp-content/uploads/files/media/image/WindowsLiveWriter/7ab6229b7fb2_14B28/image_thumb_16.png" width="244" height="185" /></a> </p>  <p>If the application is installed out-of-browser already, the InstallView control will alert the user and disable the Install button. Again, the InstallView control is only displayed when running in browser.</p>  <p><strong><u>Auto-Updates</u></strong></p>  <p>The application automatically checks for updates and, if found, retrieves the update and alerts the user to close and re-open the application to get the update. The code is quite simple to do this … simply handle the App.Current object’s CheckAndDownloadUpdateCompleted event, check for the update, and in the event handler alert the user (see the code below).</p>

<pre class="prettyprint linenums">
public MainPage()
{
    InitializeComponent();

    int refreshInterval = 33; // ms
    _timer = new DispatcherTimer() { Interval = TimeSpan.FromMilliseconds(refreshInterval) };
    _timer.Tick += new EventHandler(timer_Tick);

    this.Loaded += new RoutedEventHandler(MainPage_Loaded);
    App.Current.CheckAndDownloadUpdateCompleted += CheckAndDownloadUpdateCompleted;
    App.Current.CheckAndDownloadUpdateAsync();
}

private void CheckAndDownloadUpdateCompleted(object sender, CheckAndDownloadUpdateCompletedEventArgs e)
{
    if (App.Current.IsRunningOutOfBrowser && e.UpdateAvailable)
    {
        MessageBox.Show(
            "A new update is available for the Multi-Touch Puzzle. Please close the application and restart it to install the latest update.",
            "Multi-Touch Puzzle Update Available",
            MessageBoxButton.OK);
    }
}
</pre>

<p><strong><u>Wrap-Up</u></strong></p>
<p>That’s the application from a high level. The logic to rotate the pieces, give accelerate and decelerate them when moved, and to scramble &amp; solve them is a little more involved. But the code is here so you can dive in and follow along to understand these aspects. If you have any questions please drop me a comment or an email. Once again <a href="http://www.silverlight.net/community/samples/silverlight-4-beta/HTML-Puzzle/">you can download the entire sample from here</a>. </p>
<p><em>NOTE: This application requires Silverlight 4 Beta</em></p>
